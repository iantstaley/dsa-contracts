# <p align="center"> DSA Contracts Tests</p>

## Code coverage

All the contracts in action have been tested and covered by the tests.<br>
Test Coverage as of **June 28, 2022**:
- Statements: `303/308`
- Branches: `191/200`
- Functions: `104/107`
- Lines: `319/324`

![Screenshot from 2022-06-28 14-40-42](https://user-images.githubusercontent.com/76250660/176197453-cfa7b1d5-76b7-4c63-9604-4bb9b9e54875.png)

The missing numbers in the coverage can be accounted for:

- **Functions** (missing - 3):
  - [DSMath helper contract](https://github.com/Instadapp/dsa-contracts/blob/master/contracts/v1/connectors.sol#L19) in v1 module. This helper contract is not used in the main contract, as there are no major mathematical calculations involved in the main contract - InstaAccount. So the internal functions `add()` and `sub()` aren't included in the tests. These functions have been covered in tests of [other contracts](https://github.com/Instadapp/dsa-contracts/blob/master/contracts/registry/list.sol#L13) which are using it for significant mathematical calculations. `(-2)`
  - [InstaIndex](https://github.com/Instadapp/dsa-contracts/blob/master/contracts/registry/index.sol#L153) The method `buildWithCast()` has been skipped while testing as this is not used presently in the working. `(-1)`
- **Branches** (missing - 9):
  - The branches(else condition) associated with the [DSMath](https://github.com/Instadapp/dsa-contracts/blob/master/contracts/registry/list.sol#L15) contract related to overflow which haven't been covered while testing. Appropriate check for overflow of `uint256` is added which ensures that there won't be any overflow while calculation. Testing it would requires a large number of connectors(greater than max value of `uint256`) to be generated and added to the registry such that an overflow occurs, which is not feasible or significant for testing. `(-6)`
  - Two branches associated with `buildWithCast` method stated in functions. `(-2)`
  - 'If' [condition](https://github.com/Instadapp/dsa-contracts/blob/master/contracts/v2/proxy/accountProxy.sol#L69) in `receive()`: This condition will not be reached usually, hence skipped from testing. Even if in any scenario, this condition is reached it is simply calling the `_fallback()` which has been tested separately several times. `(-1)`
- **Statements & lines**

  - The lines and statements associated with above stated functions/branches are uncovered.

### Run the coverage:

```
npm run coverage
```

## Estimated Gas Consumption

The gas estimate of the main contracts as per _hardhat-gas-reporter_ as of July 1, 2022 is presented in the following report. To generate the result of gas estimate:

```
npx hardhat test
```

The command will execute all the tets and tabulate the gas estimates per contract and methods.
The average gas consumption (13 gwei/gas) is as follows: 

<pre>
·-----------------------------------------------------------|------------------------|-------------|-------------------·
|                 Solc version 0.6.0                        ·Optimizer enabled:false ·  Runs: 200  ·Block limit:100 gas│
····························································|························|·············|····················
|  Methods                                                  ·           13 gwei/gas                ·   1.00 eth/eth    │
································|···························|··········|·············|·············|··········|·········
|  Contract                     ·  Method                   ·          ·  Max        ·  Avg        · calls    · (avg)  │
································|···························|··········|·············|·············|··········|·········
|  AddressIndex                 ·  addNewAccount            ·   68416  ·      68483  ·      68461  ·       6  ·  0.00  │
································|···························|··········|·············|·············|··········|·········
|  Implementations              ·  addImplementation        ·  100277  ·     192905  ·     131153  ·       6  ·  0.00  │
································|···························|··········|·············|·············|··········|·········
|  Implementations              ·  removeImplementation     ·   36690  ·      55535  ·      46113  ·       4  ·  0.00  │
································|···························|··········|·············|·············|··········|·········
|  Implementations              ·  setDefaultImplementation ·       -  ·          -  ·      34147  ·       2  ·  0.00  │
································|···························|··········|·············|·············|··········|·········
|  InstaAccount                 ·  cast                     ·   92758  ·     182812  ·     150178  ·      16  ·  0.00  │
································|···························|··········|·············|·············|··········|·········
|  InstaAccount                 ·  disable                  ·   59204  ·      76225  ·      70312  ·      14  ·  0.00  │
································|···························|··········|·············|·············|··········|·········
|  InstaAccount                 ·  enable                   ·  139375  ·     167232  ·     154037  ·      14  ·  0.00  │
································|···························|··········|·············|·············|··········|·········
|  InstaAccount                 ·  switchShield             ·   28312  ·      60824  ·      50046  ·       8  ·  0.00  │
································|···························|··········|·············|·············|··········|·········
|  InstaCheck                   ·  change                   ·   23693  ·      43605  ·      33649  ·       2  ·  0.00  │
································|···························|··········|·············|·············|··········|·········
|  InstaConnectors              ·  disable                  ·       -  ·          -  ·      36247  ·       2  ·  0.00  │
································|···························|··········|·············|·············|··········|·········
|  InstaConnectors              ·  disableChief             ·   25485  ·      30977  ·      28231  ·       4  ·  0.00  │
································|···························|··········|·············|·············|··········|·········
|  InstaConnectors              ·  enable                   ·   84985  ·     124636  ·     104811  ·       4  ·  0.00  │
································|···························|··········|·············|·············|··········|·········
|  InstaConnectors              ·  enableChief              ·   47411  ·      52891  ·      49238  ·       6  ·  0.00  │
································|···························|··········|·············|·············|··········|·········
|  InstaConnectors              ·  enableStatic             ·       -  ·          -  ·      96990  ·       2  ·  0.00  │
································|···························|··········|·············|·············|··········|·········
|  InstaConnectorsV2            ·  addConnectors            ·   58385  ·     128899  ·      73760  ·      25  ·  0.00  │
································|···························|··········|·············|·············|··········|·········
|  InstaConnectorsV2            ·  removeConnectors         ·   36265  ·      42649  ·      38097  ·       8  ·  0.00  │
································|···························|··········|·············|·············|··········|·········
|  InstaConnectorsV2            ·  toggleChief              ·   30055  ·      51955  ·      45694  ·       7  ·  0.00  │
································|···························|··········|·············|·············|··········|·········
|  InstaConnectorsV2            ·  updateConnectors         ·   42244  ·      68208  ·      49366  ·       4  ·  0.00  │
································|···························|··········|·············|·············|··········|·········
|  InstaDefaultImplementation   ·  toggleBeta               ·   36205  ·      58105  ·      47155  ·       4  ·  0.00  │
································|···························|··········|·············|·············|··········|·········
|  InstaImplementationM1        ·  cast                     ·   65501  ·     411966  ·     203312  ·      86  ·  0.00  │
································|···························|··········|·············|·············|··········|·········
|  InstaImplementations         ·  addImplementation        ·  100265  ·     239219  ·     140273  ·      22  ·  0.00  │
································|···························|··········|·············|·············|··········|·········
|  InstaImplementations         ·  removeImplementation     ·   36680  ·      64957  ·      52391  ·       6  ·  0.00  │
································|···························|··········|·············|·············|··········|·········
|  InstaImplementations         ·  setDefaultImplementation ·   34147  ·      51247  ·      43918  ·      14  ·  0.00  │
································|···························|··········|·············|·············|··········|·········
|  InstaIndex                   ·  addNewAccount            ·   57816  ·     102974  ·      83986  ·      12  ·  0.00  │
································|···························|··········|·············|·············|··········|·········
|  InstaIndex                   ·  build                    ·  228239  ·     259453  ·     245513  ·      32  ·  0.00  │
································|···························|··········|·············|·············|··········|·········
|  InstaIndex                   ·  changeCheck              ·       -  ·          -  ·      48429  ·       6  ·  0.00  │
································|···························|··········|·············|·············|··········|·········
|  InstaIndex                   ·  changeMaster             ·       -  ·          -  ·      47822  ·       2  ·  0.00  │
································|···························|··········|·············|·············|··········|·········
|  InstaIndex                   ·  setBasics                ·       -  ·          -  ·     135858  ·      10  ·  0.00  │
································|···························|··········|·············|·············|··········|·········
|  InstaIndex                   ·  updateMaster             ·       -  ·          -  ·      28332  ·       2  ·  0.00  │
································|···························|··········|·············|·············|··········|·········
|  InstaMemory                  ·  getAddr                  ·       -  ·          -  ·      22288  ·       2  ·  0.00  │
································|···························|··········|·············|·············|··········|·········
|  InstaMemory                  ·  getBytes                 ·       -  ·          -  ·      22047  ·       2  ·  0.00  │
································|···························|··········|·············|·············|··········|·········
|  InstaMemory                  ·  getUint                  ·       -  ·          -  ·      22091  ·       2  ·  0.00  │
································|···························|··········|·············|·············|··········|·········
|  InstaMemory                  ·  setAddr                  ·       -  ·          -  ·      44257  ·       2  ·  0.00  │
································|···························|··········|·············|·············|··········|·········
|  InstaMemory                  ·  setBytes                 ·       -  ·          -  ·      44232  ·       2  ·  0.00  │
································|···························|··········|·············|·············|··········|·········
|  InstaMemory                  ·  setUint                  ·       -  ·          -  ·      43904  ·       2  ·  0.0
································|···························|··········|·············|·············|··········|·········
|  Deployments                                              ·                                      ·% of limit·        │
····························································|··········|·············|·············|··········|·········
|  ConnectAuth                                              ·       -  ·          -  ·     464651  ·   3.9 %  ·  0.01  │
····························································|··········|·············|·············|··········|·········
|  ConnectBasic                                             ·       -  ·          -  ·     902070  ·   7.5 %  ·  0.01  │
····························································|··········|·············|·············|··········|·········
|  ConnectCompound                                          ·       -  ·          -  ·    1953712  ·  16.3 %  ·  0.03  │
····························································|··········|·············|·············|··········|·········
|  ConnectV2Auth                                            ·       -  ·          -  ·     580386  ·   4.8 %  ·  0.01  │
····························································|··········|·············|·············|··········|·········
|  ConnectV2Beta                                            ·       -  ·          -  ·     398730  ·   3.3 %  ·  0.01  │
····························································|··········|·············|·············|··········|·········
|  ConnectV2EmitEvent                                       ·       -  ·          -  ·     221378  ·   1.8 %  ·  0.00  │
····························································|··········|·············|·············|··········|·········
|  InstaAccount                                             ·       -  ·          -  ·    1497767  ·  12.5 %  ·  0.02  │
····························································|··········|·············|·············|··········|·········
|  InstaAccountV2                                           ·       -  ·          -  ·     227998  ·   1.9 %  ·  0.00  │
····························································|··········|·············|·············|··········|·········
|  InstaCheck                                               ·       -  ·          -  ·     116239  ·     1 %  ·  0.00  │
····························································|··········|·············|·············|··········|·········
|  InstaConnectors                                          ·       -  ·          -  ·    1619112  ·  13.5 %  ·  0.02  │
····························································|··········|·············|·············|··········|·········
|  InstaConnectorsV2                                        ·       -  ·          -  ·    1773714  ·  14.8 %  ·  0.02  │
····························································|··········|·············|·············|··········|·········
|  InstaDefaultImplementation                               ·       -  ·          -  ·    1047196  ·   8.7 %  ·  0.01  │
····························································|··········|·············|·············|··········|·········
|  InstaEvent                                               ·       -  ·          -  ·     233002  ·   1.9 %  ·  0.00  │
····························································|··········|·············|·············|··········|·········
|  InstaImplementationM1                                    · 1068503  ·    1068515  ·    1068509  ·   8.9 %  ·  0.01  │
····························································|··········|·············|·············|··········|·········
|  InstaImplementations                                     ·       -  ·          -  ·    1242648  ·  10.4 %  ·  0.02  │
····························································|··········|·············|·············|··········|·········
|  InstaIndex                                               ·       -  ·          -  ·    1885904  ·  15.7 %  ·  0.02  │
····························································|··········|·············|·············|··········|·········
|  InstaList                                                ·       -  ·          -  ·    1947836  ·  16.2 %  ·  0.03  │
····························································|··········|·············|·············|··········|·········
|  InstaMemory                                              ·       -  ·          -  ·     371297  ·   3.1 %  ·  0.00  │
····························································|··········|·············|·············|··········|·········

</pre>

